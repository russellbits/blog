import{b as X,e as Z,i as z,a as U}from"./forms.d0ac8a00.js";import{p as R}from"./stores.6819fe79.js";import{w as h,d as F}from"./singletons.1b809a60.js";import{Q as $,V as K}from"./index.2ad7cf28.js";import{U as J,N as ee,P as te,a as re,b as L,H as ne}from"./parse.7d180a0f.js";const ae=!0;class V extends Error{constructor(r,c){super(r),this.name="DevalueError",this.path=c.join("")}}function G(e){return Object(e)!==e}const se=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function ie(e){const r=Object.getPrototypeOf(e);return r===Object.prototype||r===null||Object.getOwnPropertyNames(r).sort().join("\0")===se}function oe(e){return Object.prototype.toString.call(e).slice(8,-1)}function ce(e){switch(e){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e<" "?`\\u${e.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function j(e){let r="",c=0;const T=e.length;for(let E=0;E<T;E+=1){const l=e[E],a=ce(l);a&&(r+=e.slice(c,E)+a,c=E+1)}return`"${c===0?e:r+e.slice(c)}"`}function le(e,r){const c=[],T=new Map,E=[];for(const s in r)E.push({key:s,fn:r[s]});const l=[];let a=0;function b(s){if(typeof s=="function")throw new V("Cannot stringify a function",l);if(T.has(s))return T.get(s);if(s===void 0)return J;if(Number.isNaN(s))return ee;if(s===1/0)return te;if(s===-1/0)return re;if(s===0&&1/s<0)return L;const S=a++;T.set(s,S);for(const{key:v,fn:A}of E){const y=A(s);if(y)return c[S]=`["${v}",${b(y)}]`,S}let i="";if(G(s))i=B(s);else switch(oe(s)){case"Number":case"String":case"Boolean":i=`["Object",${B(s)}]`;break;case"BigInt":i=`["BigInt",${s}]`;break;case"Date":i=`["Date","${!isNaN(s.getDate())?s.toISOString():""}"]`;break;case"RegExp":const{source:y,flags:M}=s;i=M?`["RegExp",${j(y)},"${M}"]`:`["RegExp",${j(y)}]`;break;case"Array":i="[";for(let n=0;n<s.length;n+=1)n>0&&(i+=","),n in s?(l.push(`[${n}]`),i+=b(s[n]),l.pop()):i+=ne;i+="]";break;case"Set":i='["Set"';for(const n of s)i+=`,${b(n)}`;i+="]";break;case"Map":i='["Map"';for(const[n,p]of s)l.push(`.get(${G(n)?B(n):"..."})`),i+=`,${b(n)},${b(p)}`,l.pop();i+="]";break;default:if(!ie(s))throw new V("Cannot stringify arbitrary non-POJOs",l);if(Object.getOwnPropertySymbols(s).length>0)throw new V("Cannot stringify POJOs with symbolic keys",l);if(Object.getPrototypeOf(s)===null){i='["null"';for(const n in s)l.push(`.${n}`),i+=`,${j(n)},${b(s[n])}`,l.pop();i+="]"}else{i="{";let n=!1;for(const p in s)n&&(i+=","),n=!0,l.push(`.${p}`),i+=`${j(p)}:${b(s[p])}`,l.pop();i+="}"}}return c[S]=i,S}const k=b(e);return k<0?`${k}`:`[${c.join(",")}]`}function B(e){const r=typeof e;return r==="string"?j(e):e instanceof String?j(e.toString()):e===void 0?J.toString():e===0&&1/e<0?L.toString():r==="bigint"?`["BigInt","${e}"]`:String(e)}const ue=ae,fe=(e,r=0)=>{const c=e.getBoundingClientRect();return c.top>=r&&c.left>=0&&c.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&c.right<=(window.innerWidth||document.documentElement.clientWidth)},de=(e,r=1.125,c="smooth")=>{const l=e.getBoundingClientRect().top+window.pageYOffset-window.innerHeight/(2*r);window.scrollTo({left:0,top:l,behavior:c})};function Q(e,r){if(e===r)return!0;if(e===null||r===null)return!1;if(typeof e=="object"&&typeof r=="object"){if(Object.keys(e).length!==Object.keys(r).length)return!1;for(const c in e)if(!Q(e[c],r[c]))return!1;return!0}else return!1}var w;(function(e){e[e.Idle=0]="Idle",e[e.Submitting=1]="Submitting",e[e.Delayed=2]="Delayed",e[e.Timeout=3]="Timeout"})(w||(w={}));const me={applyAction:!0,invalidateAll:!0,resetForm:!1,autoFocusOnError:"detect",scrollToError:"smooth",errorSelector:"[data-invalid]",stickyNavbar:void 0,taintedMessage:"Do you want to leave this page? Changes you made may not be saved.",onSubmit:void 0,onResult:void 0,onUpdate:void 0,onUpdated:void 0,onError:"set-message",dataType:"form",validators:void 0,defaultValidator:"clear",clearOnSubmit:"errors-and-message",delayMs:500,timeoutMs:8e3,multipleSubmits:"prevent"};function ve(e,r={}){r={...me,...r};function c(){return{valid:!1,errors:{},data:{},empty:!0,message:null,constraints:{}}}function T(t){return Object.values(t).filter(o=>E(o)!==!1)}function E(t){return!t||typeof t!="object"||!("valid"in t&&"empty"in t&&typeof t.valid=="boolean")?!1:"id"in t&&typeof t.id=="string"?t.id:void 0}if(typeof e=="string"&&typeof r.id=="string")throw new Error("You cannot specify an id in the first superForm argument and in the options.");const l=typeof e=="string"?e:r.id??(e==null?void 0:e.id),a=$(R).form;if(r.applyAction&&a){const t=E(a.form);if(t===!1)throw new Error("ActionData didn't return a Validation object. Make sure you return { form } in the form actions.");t===l&&(e=a.form)}(!e||typeof e=="string")&&(e=c());const b={...e,data:{...e.data},errors:{...e.errors},constraints:{...e.constraints}},k=h(e.valid),s=h(e.empty),S=h(e.message),i=h({...e.errors}),v=h({...e.data}),A=h({...e.constraints}),y=h(!1),M=h(!1),n=h(!1),p=F(i,t=>t?Object.entries(t).flatMap(([o,g])=>(g==null?void 0:g.map(m=>({key:o,value:m})))??[]):[]),I=F(p,t=>t[0]??null),u=F(v,t=>d?D(t):!1);if(typeof b.valid!="boolean")throw new Error("A non-validation object was passed to superForm. Check what's passed to its first parameter (null is allowed).");let d;const N=r.taintedMessage;r.taintedMessage=void 0;function O(){r.taintedMessage=N,d={...$(v)}}function D(t){return!Q(t,d)}function P(t,o,g){o&&(d={...t.data}),v.set(t.data),S.set(g??t.message),s.set(t.empty),k.set(t.valid),i.set(t.errors)}async function q(t,o){if(r.onUpdate){let g=!1;if(await r.onUpdate({form:t,cancel:()=>g=!0}),g){Y();return}}t.valid&&r.resetForm?C(t.message):P(t,o,null),r.onUpdated&&r.onUpdated({form:t})}function C(t){P(b,!0,t)}const H=async(t,o)=>{if(t.type=="error")throw new Error(`ActionResult of type "${t.type}" cannot be passed to update function.`);if(t.type=="redirect"){r.resetForm&&C(null);return}if(typeof t.data!="object")throw new Error("Non-object validation data returned from ActionResult.");const g=T(t.data);if(!g.length)throw new Error("No form data returned from ActionResult. Make sure you return { form } in the form actions.");for(const m of g)m.id===l&&await q(m,o??(t.status>=200&&t.status<300))};{X(o=>{r.taintedMessage&&!$(y)&&$(u)&&!window.confirm(r.taintedMessage)&&o.cancel()});let t={...b.data};v.subscribe(async o=>{var g,m;if(!$(y)){for(const f of Object.keys(o)){if(o[f]===t[f]||!o[f]&&!t[f]||(o[f]instanceof Date||t[f]instanceof Date)&&(isNaN(o[f])&&isNaN(t[f])||((g=o[f])==null?void 0:g.getTime())==((m=t[f])==null?void 0:m.getTime())))continue;const W=r.validators&&r.validators[f];if(W){const _=await W(o[f]);i.update(x=>(_?x[f]=Array.isArray(_)?_:[_]:delete x[f],x))}else r.defaultValidator=="clear"&&i.update(_=>(delete _[f],_))}t={...o}}}),r.applyAction&&R.subscribe(async o=>{function g(m){throw new Error(`No form data found in ${m}. Make sure you return { form } in the form actions and load function.`)}if(o.form&&typeof o.form=="object"){const m=T(o.form);m.length||g("$page.form (ActionData)");for(const f of m)f===e||f.id!==l||await q(f,o.status>=200&&o.status<300)}else if(o.data&&typeof o.data=="object"){const m=T(o.data);for(const f of m)f===e||f.id!==l||P(f,o.status>=200&&o.status<300,null)}})}function Y(){r.flashMessage&&ue&&(document.cookie="flash=; Max-Age=0; Path=/;")}return{form:v,errors:i,message:S,constraints:A,fields:F([v,i,A],([t,o,g])=>Object.keys(t).map(m=>({name:m,value:t[m],errors:o[m],constraints:g[m],type:b.meta?b.meta.types[m]:void 0}))),tainted:F(u,t=>t),valid:F(k,t=>t),empty:F(s,t=>t),submitting:F(y,t=>t),delayed:F(M,t=>t),timeout:F(n,t=>t),enhance:t=>ye(t,y,M,n,i,H,r,v,S,O,Y),firstError:I,allErrors:p,update:H,reset:t=>C(t!=null&&t.keepMessage?$(S):null)}}function ye(e,r,c,T,E,l,a,b,k,s,S){s();function i(y){function M(){n=y}let n;function p(u){return typeof a.autoFocusOnError=="boolean"?a.autoFocusOnError:!/iPhone|iPad|iPod|Android/i.test(u)}const I=async()=>{if(a.scrollToError=="off")return;const u=a.errorSelector;if(!u)return;await K();let d;if(d=n.querySelector(u),!d)return;d=d.querySelector(u)??d;const N=a.stickyNavbar?document.querySelector(a.stickyNavbar):null;if(fe(d,(N==null?void 0:N.offsetHeight)??0)||de(d,void 0,a.scrollToError),!p(navigator.userAgent))return;let O;O=d,["INPUT","SELECT","BUTTON","TEXTAREA"].includes(O.tagName)||(O=O.querySelector('input:not([type="hidden"]):not(.flatpickr-input), select, textarea'));try{O==null||O.focus({preventScroll:!0})}catch{}};{let u=w.Idle,d,N;const O=D=>{u=D,r.set(u>=w.Submitting),c.set(u>=w.Delayed),T.set(u>=w.Timeout)};return{submitting:()=>{M(),O(u!=w.Delayed?w.Submitting:w.Delayed),d&&clearTimeout(d),N&&clearTimeout(N),d=window.setTimeout(()=>{u==w.Submitting&&O(w.Delayed)},a.delayMs),N=window.setTimeout(()=>{u==w.Delayed&&O(w.Timeout)},a.timeoutMs)},completed:D=>{d&&clearTimeout(d),N&&clearTimeout(N),d=N=0,O(w.Idle),D||I()},isSubmitting:()=>u===w.Submitting||u===w.Delayed}}}const v=i(e);let A;return Z(e,async y=>{let M=!1;if(v.isSubmitting()&&a.multipleSubmits=="prevent")M=!0,y.cancel();else if(v.isSubmitting()&&a.multipleSubmits=="abort"&&A&&A.abort(),A=y.controller,a.onSubmit){const n={...y,cancel:()=>(M=!0,y.cancel())};a.onSubmit(n)}if(M)S();else{switch(a.clearOnSubmit){case"errors-and-message":E.set({}),k.set(null);break;case"errors":E.set({});break;case"message":k.set(null);break}switch(a.flashMessage&&(a.clearOnSubmit=="errors-and-message"||a.clearOnSubmit=="message")&&a.flashMessage.module.getFlash(R).set(void 0),v.submitting(),a.dataType){case"json":y.data.set("__superform_json",le($(b)));break;case"formdata":for(const[n,p]of Object.entries($(b)))y.data.set(n,p instanceof Blob?p:`${p||""}`);break}}return async({result:n})=>{A=null;let p=!1;if(a.onResult&&await a.onResult({result:n,update:l,formEl:e,cancel:()=>p=!0}),p)S();else{const I=Math.floor(n.status||500);let u;n.type!=="error"?(n.type==="success"&&a.invalidateAll&&await z(),a.applyAction?await U(n):await l(n)):(a.applyAction&&(a.onError=="apply"?await U(n):await U({type:"failure",status:I})),a.onError=="ignore"||(a.onError=="set-message"?k.set(u=n.error.message!==void 0?n.error.message:`Error: ${I}`):typeof a.onError=="string"?k.set(u=a.onError):a.onError&&await a.onError(n,k))),a.flashMessage&&(n.type=="error"&&a.flashMessage.onError?(u&&n.error&&typeof n.error=="object"&&"message"in n.error&&(n.error.message=u),a.flashMessage.module.getFlash(R).set(a.flashMessage.onError({...n,status:n.status??I}))):n.type!="error"&&a.flashMessage.module.updateFlash(R))}v.completed(p)}})}export{ve as s};
